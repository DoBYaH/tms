<div data-scope="flow">
	<div data---="viewbox__null__parent:auto;visibleX:true;visibleY:true;scrollbar:true;margin:30;scrollbarshadow:1">
		<div data---="flow__?.data__width:6000;height:6000;grid:16;horizontal:1;snapping:5;steplines:1;infopath:?.info;undopath:?.undo;redopath:?.redo;ondrop:?/drop;contextmenu:?/contextmenu;dblclick:?/settings;outputoffsetY:15;inputoffsetY:15"></div>
	</div>
	<div class="stats"><i class="fa fa-refresh fa-spin mr5"></i> @(Processed messages:) <b data-bind="?.stats.messages__text__empty__format:0"></b> / pending <span class="gray" data-bind="?.stats.pending__text__empty__format:0"></span></div>
</div>

<script id="template_flowsettings" type="text/html">
	<div data-scope="flow.settings.@NAME@" id="@NAME@">
		@BODY@
	</div>
</script>

<div data---="largeform__common.form__if:settings;width:800;visibleY:1;icon:fa fa-cog;submit:flow/settings_submit;$id:flowsettings" class="hidden invisible">
	<div id="flow_settings"></div>
	<nav data---="validation__settings__$id:settingsvalidation">
		<button name="submit"><i class="far fa-check-circle"></i>@(APPLY)</button>
		<button name="cancel">@(Cancel)</button>
	</nav>
</div>

<div data---="panel__common.panel__if:readme;width:500;title:@(Read me);zindex:10">
	<div data-bind="common.readme__html:value?Thelpers.markdown(value, { element: el }):''" class="padding"></div>
</div>

<div data---="importer__common.form2__if:sourceform;url:/forms/source.html"></div>
<div data---="importer__common.form__if:sourcesform;url:/forms/sources.html"></div>

<!-- A temporary repository for components settings -->
<div id="flow_repo" class="hidden"></div>

<script>

	if (!W.flow)
		W.flow = { data: {}, console: {} };

	// Reads flow statuses
	SETTER(true, 'websocket/send', { TYPE: 'flow' });

	PLUGIN('flow', function(exports) {

		var initialized_settings = {};
		var settings_current;

		exports.init = function() {
			ADD('websocket__null__url:/?openplatform=' + (NAV.query.openplatform || '') + ';encoder:false');
		};

		exports.reload = function() {
		};

		exports.add = function() {
			SET('sourceform @default', {});
			SET('common.form2', 'sourceform');
		};

		exports.sources = function() {
			SET('common.form', 'sourcesform');
		};

		exports.clear = function() {
			SETTER('approve/show', '@(Are you sure you want to clear the current Flow?)', '"trash-o" @(Clear)', function() {
				SET('?.data', {});
			});
		};

		exports.operation = function(el) {
			var type = el.attrd('type');
			var name = type === 'in' || type === 'out' || type === 'reset' ? 'zoom' : type;
			if (name !== 'zoom')
				type = '';
			CMD('flow.' + name, type);
		};

		exports.contextmenu = function(e, type, meta) {

			var item = GET('?.info.selected');
			if (!item)
				return;

			var opt = {};
			opt.x = e.pageX;
			opt.y = e.pageY;
			opt.items = [];
			opt.items.push({ id: 'remove', name: '@(Remove)', icon: 'far fa-trash-alt red' });
			opt.callback = function(item) {
				switch (item.id) {
					case 'remove':
						CMD('flow.selected.clear');
						break;
				}
			};
			SETTER('menu/show', opt);
		};

		exports.settings = function(instance) {

			var component = flow.components.findItem('id', instance.component);
			if (!component || !component.settings)
				return;

			var id = 'settings_f' + component.id;
			var dom = $('#flow_settings')[0];
			var domrepo = $('#flow_repo')[0];
			var domsettings = $('#' + id)[0];
			var move = false;

			if (dom.children[0] && dom.children[0] !== domsettings) {
				domrepo.appendChild(dom.children[0]);
				move = true;
			}

			RECONFIGURE('#flowsettings', { title: '@(Settings): ' + component.name });

			if (initialized_settings[id]) {
				if (move)
					dom.appendChild(domsettings);
			} else {
				initialized_settings[id] = 1;
				$('#flow_settings').aclass('invisible').append($('#template_flowsettings').html().replace(/@NAME@/g, id).replace(/@BODY@/g, component.settings));
				COMPILE();
			}

			settings_current = instance;
			setTimeout(() => $('#flow_settings').rclass('invisible'), 1000);
			SETTER('#settingsvalidation/setPath', 'flow.settings.' + id);
			SET('flow.settings.{0} @reset'.format(id), CLONE(instance.config));
			SET('common.form', 'settings');
		};

		exports.settings_submit = function(hide) {

			var model = GET(FIND('#settingsvalidation').path + ' @clone');
			settings_current.config = model;

			if (settings_current.connected) {
				// Send to the server
				SETTER('websocket/send', { TYPE: 'reconfigure', id: settings_current.id, data: model });
				SETTER('notifybar/success', '@(Settings have been applied successfully)');
			}

			hide();
		};

		exports.readme = function(el) {
			var id = el.attrd2('id');
			var model = GET('?');
			var item = model.components.findItem('id', id);
			if (item) {
				SET('common.readme', item.readme || '');
				SET('common.panel', 'readme');
			}
		};

		exports.submit = function() {

			SETTER('approve/show', '@(Are you sure you want to save and apply Flow?)', '"far fa-check-circle" @(Continue)', function() {

				var model = flow.data;
				var output = {};
				var keys = Object.keys(model);

				for (var i = 0; i < keys.length; i++) {
					var key = keys[i];
					var com = model[key];

					if (key === 'paused') {
						output[key] = com;
						continue;
					}

					var item = {};

					item.id = com.id;
					item.connections = com.connections;
					item.config = com.config;
					item.component = com.component;
					item.x = com.x;
					item.y = com.y;

					output[item.id] = item;
				}

				SETTER('websocket/send', { TYPE: 'save', data: output });
				CMD('flow.reset');
			});

		};

		exports.drop = function(e, grid) {
			var id = e.el.attrd('id');
			var com = flow.components.findItem('id', id);
			var obj = {};
			obj.id = 'f' + Date.now().toString(36);
			obj.component = id;
			obj.x = e.offsetX;
			obj.y = e.offsetY;
			obj.outputs = com.outputs ? CLONE(com.outputs) : null;
			obj.inputs = com.inputs ? CLONE(com.inputs) : null;
			obj.config = CLONE(com.config);
			obj.html = '<figure>' + com.html.format(obj.id) + '</figure>';
			obj.template = com.template ? Tangular.compile(com.template) : null;
			obj.onmake = onmake;
			CMD('flow.components.add', obj);
		};

		var loadflow = function(response) {

			for (var key in response) {

				if (key === 'paused')
					continue;

				var obj = response[key];
				var com = flow.components.findItem('id', obj.component);

				if (com == null) {
					// component not found
					WARN('Component "{0}" not found'.format(obj.component));
					delete response[key];
					continue;
				}

				obj.html = '<figure>' + com.html.format(key) + '</figure>';
				obj.outputs = com.outputs ? CLONE(com.outputs) : null;
				obj.inputs = com.inputs ? CLONE(com.inputs) : null;
				obj.template = com.template ? Tangular.compile(com.template) : null;
				obj.onmake = onmake;
			}

			exports.scope();
			SET('?.data', response);
			CMD('flow.refresh');
		};

		var onmake = function(el) {
			var self = this;

			var type = self.component.substring(0, 3);

			if (type === 'pub')
				el.aclass('app-pub');
			else if (type === 'sub')
				el.aclass('app-sub');

			var footer = el.find('footer');
			if (footer.length) {
				var area = footer.closest('.area');
				var span = area.find('.meta').find('span');
				area[0].appendChild(footer[0]);
			} else {
				var span = el.find('.meta').find('span');
				if (span.length)
					span.css('background-color', Thelpers.color(span.html()));
				var arr = el.find('.schema span');
				for (var i = 0; i < arr.length; i++)
					$(arr[i]).css('background-color', Thelpers.color(arr[i].innerHTML));
			}
		};

		var loadcomponents = function(response) {
			var js = [];
			var css = [];
			var groups = {};

			groups.pub = [];
			groups.sub = [];
			groups.com = [];

			for (var i = 0; i < response.length; i++) {
				var com = response[i];
				com.js && js.push(com.js);
				com.css && css.push(com.css);

				if (com.schema) {
					com.schemaid = com.schema.id;
					if (com.outputs) {
						// publish
						groups.pub.push(com);
					} else {
						// subscribe
						groups.sub.push(com);
					}
				} else
					groups.com.push(com);
			}

			if (js.length)
				new Function(js.join('\n'))();

			groups.pub.quicksort('schemaid');
			groups.sub.quicksort('schemaid');
			groups.com.quicksort('name');

			exports.scope();
			CSS(css.join(''), 'flowcomponents');
			SET('?.components', response);
			SET('?.components2', groups);
		};

		// WebSocket messages
		ON('message', function(msg) {
			switch (msg.TYPE) {

				case 'flow/stats':

					if (common.page !== 'flow')
						return;

					SET('flow.stats', { messages: msg.messages, mm: msg.mm, pending: msg.pending });

					if (!NOTFOCUSED()) {
						msg.traffic.priority.wait(function(key, next) {
							var sleep = 500;
							CMD('flow.traffic', key, { delay: 100, count: msg.traffic[key], speed: 3, limit: 30 });
							setTimeout(next, sleep);
						});
					}
					break;

				case 'flow/status':
					// var refresh = W.flow && (!W.flow.status || !W.flow.status[msg.id]);
					SET('flow.status.' + msg.id, msg.data);
					// CMD('flow.refresh');
					break;

				case 'flow/console':
					SET('flow.console.' + msg.id, msg);
					// setTimeout2('refresh', ACMD('flow.refresh'), 50, 10);
					break;

				case 'flow/design':
					loadflow(msg.data);
					break;

				case 'flow/components':
					loadcomponents(msg.data);
					break;
			}

		});

		ON('online', function(is) {
			if (is)
				SETTER('loading/hide', 1000);
			else
				SETTER('loading/show', '@(Connecting to the server...)');
		});

		exports.init();
	});

	ON('markdown', function(el) {
		el.find('pre code').each(function() {
			var el = $(this);
			el.aclass('json').html(Thelpers.jsonformat(PARSE(el.html())));
		});
	});

</script>